services:
  redis:
    image: redis:alpine
    ports:
      - "127.0.0.1:6379:6379"

  worker:
    build:
      context: .
      dockerfile: server/Dockerfile
    command: celery -A server.celery_app worker --loglevel=info
    volumes:
      - sqlite_data:/app/data
      - ./documents:/app/documents
      - ./logs:/app/logs
      - ./.env:/app/.env
      - ./server:/app/server
      - ./config:/app/config
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
    env_file:
      - .env
    depends_on:
      - redis
      - backend

  backend:
    build:
      context: .
      dockerfile: server/Dockerfile
    command: uvicorn server.main:app --host 0.0.0.0 --port 8000
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - sqlite_data:/app/data
      - ./documents:/app/documents
      - ./logs:/app/logs
      - ./.env:/app/.env
      - ./server:/app/server
      - ./config:/app/config
    environment:
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY}
    env_file:
      - .env
    depends_on:
      - redis

  frontend:
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "127.0.0.1:${APP_PORT:-8080}:80"
    depends_on:
      - backend

  page-editor:
    build: ./page-editor
    ports:
      - "127.0.0.1:8002:80"
    volumes:
      - ./documents:/var/www/nw-page-editor/data
      - ./page-editor/index.php:/var/www/nw-page-editor/web-app/index.php
      - ./page-editor/saveFile.php:/var/www/nw-page-editor/web-app/saveFile.php
      - ./page-editor/web-app.js:/var/www/nw-page-editor/js/web-app.js
      - ./page-editor/custom.css:/var/www/nw-page-editor/css/custom.css
      - ./page-editor/custom.js:/var/www/nw-page-editor/js/custom.js
    environment:
      - CSS=css/custom.css
      - JS=js/custom.js

volumes:
  sqlite_data:
